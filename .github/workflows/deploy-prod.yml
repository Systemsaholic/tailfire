name: Deploy to Prod

on:
  push:
    branches:
      - main

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  PROD_PROJECT_REF: ${{ secrets.PROD_SUPABASE_PROJECT_REF }}

jobs:
  deploy-api-migrations:
    name: Deploy API Migrations (Drizzle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build database package
        run: pnpm --filter @tailfire/database build

      - name: Run Drizzle migrations
        working-directory: apps/api
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: pnpm db:migrate

  deploy-ota-migrations:
    name: Deploy OTA Migrations (Supabase)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Prod project
        working-directory: apps/ota
        run: supabase link --project-ref $PROD_PROJECT_REF

      - name: Push OTA migrations
        working-directory: apps/ota
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        run: |
          # FDW migration will NO-OP in Prod (local catalog schema exists)
          # Guard logic: IF has_catalog AND NOT has_foreign_catalog THEN RETURN
          # This keeps supabase_migrations table in sync across environments
          supabase db push --linked

      - name: Verify catalog access
        working-directory: apps/ota
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        run: |
          # Hard gate: fail pipeline if catalog access is broken
          supabase db query "SELECT 1 FROM catalog.cruise_lines LIMIT 1"

      - name: Log migration result
        run: echo "OTA migration completed - FDW no-ops in Prod via guard logic"

  deploy-admin:
    name: Deploy Admin to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Configure Vercel project for monorepo
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/${{ secrets.VERCEL_ADMIN_PROJECT_ID }}" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/admin","installCommand":"pnpm install","buildCommand":"pnpm --filter @tailfire/shared-types build && pnpm --filter @tailfire/admin build","framework":"nextjs"}'

      - name: Deploy Admin (Prod)
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_ADMIN_PROJECT_ID }}

  deploy-ota:
    name: Deploy OTA to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Configure Vercel project for monorepo
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/${{ secrets.VERCEL_OTA_PROJECT_ID }}" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/ota","installCommand":"pnpm install","framework":"nextjs"}'

      - name: Deploy OTA (Prod)
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_OTA_PROJECT_ID }}

  deploy-client:
    name: Deploy Client to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Configure Vercel project for monorepo
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/${{ secrets.VERCEL_CLIENT_PROJECT_ID }}" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/client","installCommand":"pnpm install","framework":"nextjs"}'

      - name: Deploy Client (Prod)
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_CLIENT_PROJECT_ID }}

  smoke-test:
    name: Smoke Test API
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-ota, deploy-client]
    steps:
      - name: Health check API (retry)
        run: |
          for i in {1..10}; do
            if curl -sf https://api.tailfire.ca/api/v1/health; then
              echo "✅ API health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "❌ API health check failed after 10 attempts"
          exit 1

name: Deploy to Prod

on:
  push:
    branches:
      - main

jobs:
  deploy-api-migrations:
    name: Deploy API Migrations (Drizzle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          inject-env-vars: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build database package
        run: pnpm --filter @tailfire/database build

      - name: Run Drizzle migrations
        working-directory: apps/api
        run: pnpm db:migrate

  deploy-ota-migrations:
    name: Deploy OTA Migrations (Supabase)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          inject-env-vars: true

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Prod project
        working-directory: apps/ota
        run: supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Push OTA migrations
        working-directory: apps/ota
        run: |
          # FDW migration will NO-OP in Prod (local catalog schema exists)
          # Guard logic: IF has_catalog AND NOT has_foreign_catalog THEN RETURN
          # This keeps supabase_migrations table in sync across environments
          supabase db push --linked

      - name: Verify catalog access
        working-directory: apps/ota
        run: |
          # Hard gate: fail pipeline if catalog access is broken
          supabase db query "SELECT 1 FROM catalog.cruise_lines LIMIT 1"

      - name: Log migration result
        run: echo "OTA migration completed - FDW no-ops in Prod via guard logic"

  deploy-admin:
    name: Deploy Admin to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_ADMIN_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/admin"}'

      - name: Deploy Admin (Prod)
        run: vercel deploy --prod --token=$VERCEL_TOKEN

  deploy-ota:
    name: Deploy OTA to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_OTA_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/ota"}'

      - name: Deploy OTA (Prod)
        run: vercel deploy --prod --token=$VERCEL_TOKEN

  deploy-client:
    name: Deploy Client to Vercel (Prod)
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_CLIENT_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/client"}'

      - name: Deploy Client (Prod)
        run: vercel deploy --prod --token=$VERCEL_TOKEN

  smoke-test:
    name: Smoke Test API
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-ota, deploy-client]
    steps:
      - name: Health check API (retry)
        run: |
          # Using Railway domain directly for reliable SSL
          for i in {1..10}; do
            if curl -sf https://api-prod-production-c75c.up.railway.app/api/v1/health; then
              echo "✅ API health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "❌ API health check failed after 10 attempts"
          exit 1

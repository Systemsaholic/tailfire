name: Deploy to Dev

on:
  push:
    branches:
      - develop

jobs:
  deploy-api-migrations:
    name: Deploy API Migrations (Drizzle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build database package
        run: pnpm --filter @tailfire/database build

      - name: Run Drizzle migrations
        working-directory: apps/api
        run: pnpm db:migrate

  deploy-ota-migrations:
    name: Deploy OTA Migrations (Supabase)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Dev project
        working-directory: apps/ota
        run: supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Push OTA migrations
        working-directory: apps/ota
        run: |
          # FDW migration will activate in Dev (no local catalog schema)
          supabase db push --linked

      - name: Verify catalog access
        working-directory: apps/ota
        run: |
          # Hard gate: fail pipeline if FDW is broken
          supabase db query "SELECT 1 FROM catalog.cruise_lines LIMIT 1"

  deploy-api:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway auth
        run: |
          echo "Checking Railway token..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_TOKEN is not set in Doppler"
            exit 1
          fi
          echo "RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN})"
          if ! railway whoami; then
            echo ""
            echo "ERROR: Railway token is invalid or expired."
            echo "To fix: Generate new token in Railway dashboard -> Settings -> Tokens"
            echo "Then update RAILWAY_TOKEN in Doppler (dev config)"
            exit 1
          fi

      - name: Deploy to Railway
        run: |
          railway link --project $RAILWAY_PROJECT_ID --environment dev
          railway up --service api-dev --detach

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for Railway deployment to start..."
          sleep 30
          for i in {1..20}; do
            if curl -sf https://api-dev-dev-13dd.up.railway.app/api/v1/health; then
              echo "‚úÖ API deployment ready"
              exit 0
            fi
            echo "Attempt $i/20 - waiting 15s..."
            sleep 15
          done
          echo "‚ùå API deployment not ready after 5 minutes"
          exit 1

  deploy-admin:
    name: Deploy Admin to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_ADMIN_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/admin"}'

      - name: Deploy Admin (Preview)
        run: VERCEL_PROJECT_ID=$VERCEL_ADMIN_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN

  deploy-ota:
    name: Deploy OTA to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_OTA_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/ota"}'

      - name: Deploy OTA (Preview)
        run: VERCEL_PROJECT_ID=$VERCEL_OTA_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN

  deploy-client:
    name: Deploy Client to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations, deploy-ota-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set root directory
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_CLIENT_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/client"}'

      - name: Deploy Client (Preview)
        run: VERCEL_PROJECT_ID=$VERCEL_CLIENT_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN

  smoke-test:
    name: Smoke Test All Services
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-admin, deploy-ota, deploy-client]
    steps:
      - name: Health check API
        run: |
          if curl -sf https://api-dev-dev-13dd.up.railway.app/api/v1/health; then
            echo "‚úÖ API health check passed"
          else
            echo "‚ùå API health check failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "üöÄ All dev deployments completed successfully!"
          echo ""
          echo "Endpoints:"
          echo "  API:    https://api-dev-dev-13dd.up.railway.app"
          echo "  Admin:  Vercel preview URL (check workflow output)"
          echo "  OTA:    Vercel preview URL (check workflow output)"
          echo "  Client: Vercel preview URL (check workflow output)"

name: Deploy to Dev

on:
  push:
    branches:
      - preview

jobs:
  deploy-api-migrations:
    name: Deploy API Migrations (Drizzle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Verify DB connection mode
        run: |
          # Transaction pooler (port 6543) doesn't support DDL - reject it
          if echo "$DATABASE_URL" | grep -q ":6543"; then
            echo "‚ùå DATABASE_URL uses transaction pooler (port 6543). Migrations require session mode (port 5432)."
            exit 1
          fi
          # Log connection mode for debugging (without exposing secrets)
          if echo "$DATABASE_URL" | grep -q "pooler.supabase.com"; then
            echo "‚úÖ Using Supavisor session pooler (port 5432) - OK for migrations"
            echo "   Note: Session pooler is acceptable for DDL given GitHub Actions IPv6 limitations"
          else
            echo "‚úÖ Using direct database connection (port 5432)"
          fi

      - name: Guard against Supabase migrations
        run: |
          if find apps/ota/supabase/migrations -maxdepth 1 -name "*.sql" -not -path "*/_archive/*" 2>/dev/null | grep -q .; then
            echo "‚ùå Found .sql files in apps/ota/supabase/migrations/"
            echo "All migrations must be in packages/database/src/migrations/ (Drizzle)"
            exit 1
          fi
          echo "‚úÖ No Supabase migrations found (Drizzle-only)"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build database package
        run: pnpm --filter @tailfire/database build

      - name: Inject FDW password
        run: |
          sed -i "s|__FDW_PASSWORD__|$FDW_CATALOG_PASSWORD|" \
            packages/database/src/migrations/20260104205000_setup_catalog_fdw.sql

      - name: Run Drizzle migrations
        working-directory: apps/api
        env:
          NODE_OPTIONS: "--dns-result-order=ipv4first"
        run: pnpm db:migrate

  deploy-api:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: |
          # Project tokens are scoped to environment, no link needed
          railway up --service api-dev --detach

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for Railway deployment to start..."
          sleep 30
          for i in {1..20}; do
            if curl -sf https://api-dev-dev-13dd.up.railway.app/api/v1/health; then
              echo "‚úÖ API deployment ready"
              exit 0
            fi
            echo "Attempt $i/20 - waiting 15s..."
            sleep 15
          done
          echo "‚ùå API deployment not ready after 5 minutes"
          exit 1

  deploy-admin:
    name: Deploy Admin to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Fix project settings
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_ADMIN_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/admin","installCommand":"pnpm install","buildCommand":"pnpm --filter @tailfire/database build && pnpm --filter @tailfire/shared-types build && pnpm --filter @tailfire/admin build"}'

      - name: Deploy Admin (Preview)
        id: deploy-admin
        run: |
          DEPLOYMENT_URL=$(VERCEL_ORG_ID=$VERCEL_ORG_ID VERCEL_PROJECT_ID=$VERCEL_ADMIN_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN --yes)
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Alias Admin to custom domain
        run: |
          vercel alias set ${{ steps.deploy-admin.outputs.deployment_url }} tf-demo.phoenixvoyages.ca --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID
          echo "‚úÖ Aliased to tf-demo.phoenixvoyages.ca"

  deploy-ota:
    name: Deploy OTA to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Fix project settings
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_OTA_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/ota","installCommand":"pnpm install","buildCommand":"pnpm --filter @tailfire/ota build"}'

      - name: Deploy OTA (Preview)
        run: VERCEL_ORG_ID=$VERCEL_ORG_ID VERCEL_PROJECT_ID=$VERCEL_OTA_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN --yes

  deploy-client:
    name: Deploy Client to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-api-migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Doppler
        uses: dopplerhq/secrets-fetch-action@v1.3.1
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          inject-env-vars: true

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Fix project settings
        run: |
          curl -s -X PATCH "https://api.vercel.com/v9/projects/$VERCEL_CLIENT_PROJECT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"rootDirectory":"apps/client","installCommand":"pnpm install","buildCommand":"pnpm --filter @tailfire/client build"}'

      - name: Deploy Client (Preview)
        run: VERCEL_ORG_ID=$VERCEL_ORG_ID VERCEL_PROJECT_ID=$VERCEL_CLIENT_PROJECT_ID vercel deploy --token=$VERCEL_TOKEN --yes

  smoke-test:
    name: Smoke Test All Services
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-admin, deploy-ota, deploy-client]
    steps:
      - name: Health check API
        run: |
          if curl -sf https://api-dev-dev-13dd.up.railway.app/api/v1/health; then
            echo "‚úÖ API health check passed"
          else
            echo "‚ùå API health check failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "üöÄ All dev deployments completed successfully!"
          echo ""
          echo "Endpoints:"
          echo "  API:    https://api-dev-dev-13dd.up.railway.app"
          echo "  Admin:  Vercel preview URL (check workflow output)"
          echo "  OTA:    Vercel preview URL (check workflow output)"
          echo "  Client: Vercel preview URL (check workflow output)"
